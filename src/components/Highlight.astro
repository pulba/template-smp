---
// file: src/components/Highlight.astro
import type { CollectionEntry } from "astro:content";
import { getEntry, getCollection } from "astro:content";
import LatestPosts from "./LatestPosts.astro";

interface PostData {
  title: string;
  author?: string;
  pubdate?: Date | string;
  heroImage?: string;
  description?: string;
  category?: string;
}

interface Post {
  slug: string;
  category: string;
  data: PostData;
}

function getSafeImageSrc(path: string | undefined): string {
  if (!path) return "/uploads/default-thumb.jpg";
  return path.startsWith("/") ? path : `/${path}`;
}

// 1. Ambil data PPDB settings
const ppdbData = await getCollection("ppdb").catch(() => []);
const ppdbSettings =
  ppdbData.find((item) => item.id === "settings") || ppdbData[0];

// 2. Ambil semua pamflate
const allPamflate = await getCollection("pamflate").catch(() => []);

// 3. Proses highlight pamflet
let pamfletToDisplay = {
  image: "/uploads/default-pamflet.jpg",
  title: "Pamflet PPDB",
  description: "",
  link: "#",
  show: true,
};

const highlightEnabled =
  ppdbSettings?.data?.highlightPamflet?.enabled !== false;
const hasHighlightData = ppdbSettings?.data?.highlightPamflet;

if (highlightEnabled && hasHighlightData) {
  const highlight = ppdbSettings.data.highlightPamflet;

  if (highlight.pamflet) {
    const pamfletId = highlight.pamflet.startsWith("pamflate/")
      ? highlight.pamflet
      : `pamflate/${highlight.pamflet}`;

    const selectedPamflet = allPamflate.find((p) => {
      return (
        p.id === pamfletId ||
        p.slug === highlight.pamflet ||
        p.id.endsWith(`/${highlight.pamflet}`)
      );
    });

    if (selectedPamflet) {
      pamfletToDisplay.image = getSafeImageSrc(selectedPamflet.data.heroImage);
      pamfletToDisplay.title = selectedPamflet.data.title;
      pamfletToDisplay.description = selectedPamflet.data.description || "";
      pamfletToDisplay.link = `/pamflate/${selectedPamflet.slug}`;
      pamfletToDisplay.show = true;
    } else {
      if (highlight.customImage) {
        pamfletToDisplay.image = getSafeImageSrc(highlight.customImage);
        pamfletToDisplay.title = highlight.customTitle || "Pamflet PPDB";
        pamfletToDisplay.description = highlight.customDescription || "";
        pamfletToDisplay.link = highlight.customLink || "#";
        pamfletToDisplay.show = true;
      }
    }
  } else if (highlight.customImage) {
    pamfletToDisplay.image = getSafeImageSrc(highlight.customImage);
    pamfletToDisplay.title = highlight.customTitle || "Pamflet PPDB";
    pamfletToDisplay.description = highlight.customDescription || "";
    pamfletToDisplay.link = highlight.customLink || "#";
    pamfletToDisplay.show = true;
  }
}

// 4. Fallback
if (
  !pamfletToDisplay.show ||
  pamfletToDisplay.image === "/uploads/default-pamflet.jpg"
) {
  const ppdbPamflets = allPamflate
    .filter((p) => {
      const isPpdbCategory = p.data.category === "ppdb";
      const isActive = p.data.active !== false;
      const hasImage = !!p.data.heroImage;
      return isPpdbCategory && isActive && hasImage;
    })
    .sort((a, b) => {
      const dateA = new Date(a.data.pubDate || 0).getTime();
      const dateB = new Date(b.data.pubDate || 0).getTime();
      return dateB - dateA;
    });

  if (ppdbPamflets.length > 0) {
    const latestPamflet = ppdbPamflets[0];
    pamfletToDisplay.image = getSafeImageSrc(latestPamflet.data.heroImage);
    pamfletToDisplay.title = latestPamflet.data.title;
    pamfletToDisplay.description = latestPamflet.data.description || "";
    pamfletToDisplay.link = `/pamflate/${latestPamflet.slug}`;
    pamfletToDisplay.show = true;
  }
}

// Ambil data profile (sambutan kepala sekolah)
const about = await getEntry("about", "index");
const sambutanKepsek = about?.data?.sambutan?.items?.[0] || null;

const sambutanTitle = sambutanKepsek?.title || "Sambutan Kepala Sekolah";
const sambutanImage = sambutanKepsek?.image
  ? getSafeImageSrc(sambutanKepsek.image)
  : "/uploads/default-thumb.jpg";

const styledExcerpt = sambutanKepsek
  ? getStyledExcerpt(sambutanKepsek.body, 250) // Increased limit slightly
  : { __html: "Sambutan kepala sekolah akan segera tersedia..." };

function getStyledExcerpt(body: string | undefined, limit: number) {
  if (!body)
    return { __html: "Sambutan kepala sekolah akan segera tersedia..." };

  let cleanText = body
    .replace(/^#+\s+/gm, "")
    .replace(/\*\*/g, "")
    .replace(/\*/g, "")
    .replace(/<[^>]*>/g, "")
    .trim();

  const paragraphs = cleanText
    .split(/\n\s*\n/)
    .filter((p) => p.trim().length > 0);

  let result = "";
  let totalLength = 0;

  for (let i = 0; i < paragraphs.length; i++) {
    const paragraph = paragraphs[i].trim();
    const lines = paragraph
      .split("\n")
      .filter((line) => line.trim().length > 0);

    for (let j = 0; j < lines.length; j++) {
      const line = lines[j].trim();

      if (totalLength + line.length > limit && i > 0) {
        const remaining = limit - totalLength;
        if (remaining > 10) {
          result += `<span class="text-gray-600 block">${line.slice(0, remaining)}...</span>`;
        }
        return { __html: result };
      }

      if (line.toLowerCase().includes("bismillah")) {
        result += `<span class="font-serif text-lg md:text-xl italic text-primary block mb-3 font-medium">${line}</span>`;
      } else if (line.toLowerCase().includes("assalamu")) {
        result += `<span class="font-bold text-gray-800 block mb-2">${line}</span>`;
      } else {
        result += `<span class="text-gray-600 leading-relaxed block">${line}</span>`;
      }

      totalLength += line.length;
    }

    if (i < paragraphs.length - 1) {
      result += '<div class="mb-3"></div>';
    }
  }

  return { __html: result };
}

const allPosts = await getCollection("posts").catch(() => []);

const processedPosts = allPosts.map((post) => {
  const filePath = post.filePath ?? "";
  let category = "";
  let slug = "";

  if (filePath.startsWith("src/content/posts/")) {
    const relPath = filePath.replace(/^src\/content\/posts\//, "");
    const parts = relPath.split("/");
    if (parts.length >= 2) {
      category = parts[0];
      slug = parts
        .slice(1)
        .join("/")
        .replace(/\.mdx?$/, "");
    }
  }

  if (!category && post.data.category) category = post.data.category;
  if (!slug) slug = post.id.split("/").pop() ?? "";

  return { slug, category, data: post.data };
});

const pengumumanPosts = processedPosts
  .filter((post) => post.category.toLowerCase() === "pengumuman")
  .sort((a, b) => {
    const dateA = new Date(a.data.pubdate ?? 0).getTime();
    const dateB = new Date(b.data.pubdate ?? 0).getTime();
    return dateB - dateA;
  });
---

<section class="py-16 md:py-24 bg-gray-50/50">
  <div class="container mx-auto px-6 grid grid-cols-1 lg:grid-cols-3 gap-10">
    <!-- Kolom 1: Pamflet & Informasi Utama (Visual) -->
    {
      pamfletToDisplay.show && (
        <div
          data-animate="fade-up"
          class="group relative rounded-2xl overflow-hidden shadow-lg hover:shadow-xl transition-all duration-500 bg-white border border-gray-100 h-fit"
        >
          <div class="absolute top-0 left-0 bg-primary/90 text-white text-xs font-bold px-4 py-2 rounded-br-xl z-20 backdrop-blur-sm">
            INFORMASI TERKINI
          </div>
          <div class="overflow-hidden">
            <img
              src={pamfletToDisplay.image}
              alt={pamfletToDisplay.title}
              loading="lazy"
              decoding="async"
              class="w-full h-auto object-cover group-hover:scale-105 transition-transform duration-700 aspect-[4/5]"
              onerror="this.onerror=null;this.src='/uploads/default-thumb.jpg';"
            />
          </div>
          <div class="p-5">
            <h3 class="font-bold text-lg mb-2 text-heading group-hover:text-primary transition-colors">
              {pamfletToDisplay.title}
            </h3>
            {pamfletToDisplay.description && (
              <p class="text-sm text-muted mb-4 line-clamp-2">
                {pamfletToDisplay.description}
              </p>
            )}
            <a
              href="/ppdb"
              class="inline-flex items-center text-sm font-semibold text-primary hover:text-secondary"
            >
              Lihat Detail{" "}
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-4 w-4 ml-1"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M17 8l4 4m0 0l-4 4m4-4H3"
                />
              </svg>
            </a>
          </div>
        </div>
      )
    }

    <!-- Kolom 2: Pengumuman (List) -->
    <div
      data-animate="fade-up"
      class="flex flex-col h-full"
      style="animation-delay: 100ms;"
    >
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-heading flex items-center gap-2">
          <span class="w-1.5 h-8 bg-primary rounded-full block"></span>
          Pengumuman
        </h2>
        <a
          href="/posts/pengumuman"
          class="text-sm font-medium text-primary hover:text-secondary transition-colors"
          >Lihat Semua</a
        >
      </div>

      <div
        class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 flex-1"
      >
        <LatestPosts
          posts={pengumumanPosts}
          maxPosts={3}
          layout="sidebar"
          showDescription={true}
        />
      </div>
    </div>

    <!-- Kolom 3: Sambutan Kepala Sekolah (Quote Style) -->
    <div
      data-animate="fade-up"
      class="lg:order-first"
      style="animation-delay: 200ms;"
    >
      <div
        class="bg-white rounded-2xl shadow-lg border border-gray-100 p-8 h-full relative overflow-hidden group"
      >
        <div
          class="absolute top-0 right-0 w-32 h-32 bg-primary/5 rounded-bl-full -mr-10 -mt-10 transition-transform group-hover:scale-110"
        >
        </div>

        <h2
          class="text-2xl font-bold mb-6 text-heading relative z-10 flex items-center gap-2"
        >
          {sambutanTitle}
        </h2>

        <div class="relative z-10">
          <div class="flex items-start gap-4 mb-6">
            <div class="relative shrink-0">
              <div
                class="w-20 h-20 rounded-full overflow-hidden border-4 border-white shadow-md"
              >
                <img
                  src={sambutanImage}
                  alt="Kepala Sekolah"
                  loading="lazy"
                  class="w-full h-full object-cover"
                  onerror="this.onerror=null;this.src='/uploads/default-thumb.jpg';"
                />
              </div>
              <div
                class="absolute -bottom-2 -right-2 bg-primary text-white p-1.5 rounded-full shadow-sm"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-4 w-4"
                  viewBox="0 0 20 20"
                  fill="currentColor"
                  ><path
                    fill-rule="evenodd"
                    d="M18 13V5a2 2 0 00-2-2H4a2 2 0 00-2 2v8a2 2 0 002 2h3l3 3 3-3h3a2 2 0 002-2zM5 7a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1zm1 3a1 1 0 100 2h3a1 1 0 100-2H6z"
                    clip-rule="evenodd"></path></svg
                >
              </div>
            </div>
          </div>

          <div class="text-sm text-gray-600 space-y-3 relative">
            <svg
              class="absolute -top-4 -left-2 w-8 h-8 text-gray-200/50 -z-10 transform -scale-x-100"
              fill="currentColor"
              viewBox="0 0 32 32"
              aria-hidden="true"
              ><path
                d="M9.352 4C4.456 7.456 1 13.12 1 19.36c0 5.088 3.072 8.064 6.624 8.064 3.36 0 5.856-2.688 5.856-5.856 0-3.168-2.208-5.472-5.088-5.472-.576 0-1.344.096-1.536.192.48-3.264 3.552-7.104 6.624-9.024L9.352 4zm16.512 0c-4.8 3.456-8.256 9.12-8.256 15.36 0 5.088 3.072 8.064 6.624 8.064 3.264 0 5.856-2.688 5.856-5.856 0-3.168-2.304-5.472-5.184-5.472-.576 0-1.248.096-1.44.192.48-3.264 3.456-7.104 6.528-9.024L25.864 4z"
              ></path></svg
            >
            <div set:html={styledExcerpt.__html} />
          </div>
        </div>

        {
          sambutanKepsek && (
            <div class="mt-6 pt-4 border-t border-gray-100 text-right">
              <a
                href="/about/sambutan"
                class="inline-block text-sm font-bold text-primary hover:text-secondary hover:underline transition-colors"
              >
                Baca Sambutan Lengkap â†’
              </a>
            </div>
          )
        }
      </div>
    </div>
  </div>
</section>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
