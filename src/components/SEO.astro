---
// src/components/SEO.astro
import { getCollection } from "astro:content";
import contactData from "../content/contact/index.json";

interface BreadcrumbItem {
  name: string;
  url: string;
}

interface SEOProps {
  title?: string;
  description?: string;
  image?: string;
  url?: string;
  type?: "website" | "article";
  publishedTime?: string;
  modifiedTime?: string;
  tags?: string[];
  noindex?: boolean;
  canonical?: string;
  breadcrumbs?: BreadcrumbItem[];
}

const {
  title = "",
  description = "",
  image = "",
  url = "",
  type = "website",
  publishedTime,
  modifiedTime,
  tags = [],
  noindex = false,
  canonical = "",
  breadcrumbs = [],
} = Astro.props;

const parseStructuredData = (dataString: string | undefined) => {
  if (!dataString) return null;
  try {
    return JSON.parse(dataString);
  } catch {
    return null;
  }
};

// Ambil data SEO dari TinaCMS
let settingsData = null;

try {
  const settingsCollection = await getCollection("settings");
  settingsData = settingsCollection[0]?.data ?? null;
} catch (error) {
  settingsData = null;
}

const seoData = settingsData?.seo || {};

const siteInfo = seoData?.siteInfo || {
  siteName: "SMP N 1 Indonesia",
  siteUrl: "https://masmifhda.sch.id",
  siteDescription: "",
  siteLogo: "",
  favicon: "/favicon.ico",
};

const globalMeta = seoData?.globalMeta || {
  titleTemplate: "%s | SMP N 1 Indonesia",
  defaultTitle: "SMP N 1 Indonesia - Sekolah Unggulan",
  defaultDescription:
    "SMP Negeri 1 Indonesia - Sekolah unggulan dengan pendidikan berbasis karakter dan prestasi",
  defaultKeywords:
    "sekolah islam, madrasah, pendidikan, SMP Negeri 1 Indonesia, sekolah unggulan",
  author: "SMP N 1 Indonesia",
};

const openGraph = seoData?.openGraph || {
  type: "website",
  locale: "id_ID",
  image: "",
  fbAppId: "",
};

const twitter = seoData?.twitter || {
  card: "summary_large_image",
  site: "",
  creator: "",
};

const analyticsConfig = seoData?.analytics || {
  gaId: "",
  googleSiteVerification: "",
  bingSiteVerification: "",
  yandexVerification: "",
};

// Generate meta tags
const pageTitle = title
  ? globalMeta.titleTemplate.replace("%s", title)
  : globalMeta.defaultTitle;

const pageDescription = description || globalMeta.defaultDescription;
const pageImage = image || openGraph.image || siteInfo.siteLogo;
const fullUrl = url
  ? `${siteInfo.siteUrl}${url.startsWith("/") ? url : "/" + url}`
  : siteInfo.siteUrl;
const pageType = type;

// Generate canonical URL
const canonicalUrl = canonical
  ? `${siteInfo.siteUrl}${canonical.startsWith("/") ? canonical : "/" + canonical}`
  : fullUrl;

// Robots meta
const robotsContent = noindex ? "noindex, nofollow" : "index, follow";

// Helper untuk URL gambar lengkap
const getFullImageUrl = (imgPath: string) => {
  if (!imgPath) return "";
  if (imgPath.startsWith("http")) return imgPath;
  return `${siteInfo.siteUrl}${imgPath.startsWith("/") ? imgPath : "/" + imgPath}`;
};

const orgStructuredData = parseStructuredData(
  seoData?.structuredData?.organization,
);
const websiteStructuredData = parseStructuredData(
  seoData?.structuredData?.website,
);

// Extract contact information
const contactDetails = contactData?.contactInfo?.details ?? [];
const phoneInfo = contactDetails.find((d: any) => d.type === "phone");
const emailInfo = contactDetails.find((d: any) => d.type === "email");
const addressInfo = contactDetails.find((d: any) => d.type === "address");

// Extract social media links
const socialLinks = contactData?.socialMedia?.links ?? [];
const sameAsLinks = socialLinks.map((link: any) => link.url).filter(Boolean);

// Extract opening hours
const operatingHours = contactData?.hours?.days ?? [];
const openingHoursSpec = operatingHours
  .map((h: any) => {
    // Parse days like "Senin - Jumat" to dayOfWeek array
    const dayMap: Record<string, string> = {
      senin: "Monday",
      selasa: "Tuesday",
      rabu: "Wednesday",
      kamis: "Thursday",
      jumat: "Friday",
      sabtu: "Saturday",
      minggu: "Sunday",
    };

    let daysOfWeek: string[] = [];
    const dayStr = h.day?.toLowerCase() ?? "";

    if (dayStr.includes(" - ")) {
      const [startDay, endDay] = dayStr
        .split(" - ")
        .map((d: string) => d.trim());
      const dayOrder = [
        "senin",
        "selasa",
        "rabu",
        "kamis",
        "jumat",
        "sabtu",
        "minggu",
      ];
      const startIdx = dayOrder.indexOf(startDay);
      const endIdx = dayOrder.indexOf(endDay);
      if (startIdx !== -1 && endIdx !== -1) {
        for (let i = startIdx; i <= endIdx; i++) {
          daysOfWeek.push(dayMap[dayOrder[i]]);
        }
      }
    } else {
      const mapped = dayMap[dayStr];
      if (mapped) daysOfWeek.push(mapped);
    }

    // Parse time like "08:00 - 14:00 WIB"
    const timeStr = h.time ?? "";
    const timeMatch = timeStr.match(/(\d{1,2}:\d{2})\s*-\s*(\d{1,2}:\d{2})/);

    return {
      "@type": "OpeningHoursSpecification",
      dayOfWeek: daysOfWeek,
      opens: timeMatch ? timeMatch[1] : "08:00",
      closes: timeMatch ? timeMatch[2] : "14:00",
    };
  })
  .filter((spec: any) => spec.dayOfWeek.length > 0);

// Enhanced Organization Schema for E-E-A-T
const enhancedOrgSchema = {
  "@context": "https://schema.org",
  "@type": "EducationalOrganization",
  "@id": `${siteInfo.siteUrl}/#organization`,
  name: siteInfo.siteName,
  alternateName: "MASMIFHDA",
  url: siteInfo.siteUrl,
  logo: {
    "@type": "ImageObject",
    url: getFullImageUrl(siteInfo.siteLogo),
    width: 200,
    height: 200,
  },
  image: getFullImageUrl(siteInfo.siteLogo),
  description: siteInfo.siteDescription || globalMeta.defaultDescription,
  ...(emailInfo?.value && { email: emailInfo.value }),
  ...(phoneInfo?.value && { telephone: phoneInfo.value }),
  ...(addressInfo?.value && {
    address: {
      "@type": "PostalAddress",
      streetAddress: addressInfo.value,
      addressLocality: "Way Tenong",
      addressRegion: "Lampung Barat",
      addressCountry: "ID",
    },
  }),
  ...(sameAsLinks.length > 0 && { sameAs: sameAsLinks }),
  ...(openingHoursSpec.length > 0 && {
    openingHoursSpecification: openingHoursSpec,
  }),
  contactPoint: [
    ...(phoneInfo?.value
      ? [
          {
            "@type": "ContactPoint",
            telephone: phoneInfo.value,
            contactType: "customer service",
            availableLanguage: ["Indonesian"],
          },
        ]
      : []),
    ...(emailInfo?.value
      ? [
          {
            "@type": "ContactPoint",
            email: emailInfo.value,
            contactType: "customer service",
            availableLanguage: ["Indonesian"],
          },
        ]
      : []),
  ],
  areaServed: {
    "@type": "Place",
    name: "Lampung Barat, Indonesia",
  },
  founder: {
    "@type": "Organization",
    name: "Yayasan Mathla'ul Anwar",
  },
};

// Generate BreadcrumbList Schema
const generateBreadcrumbSchema = () => {
  // If breadcrumbs are provided, use them
  if (breadcrumbs && breadcrumbs.length > 0) {
    return {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      itemListElement: breadcrumbs.map((item, index) => ({
        "@type": "ListItem",
        position: index + 1,
        name: item.name,
        item: `${siteInfo.siteUrl}${item.url.startsWith("/") ? item.url : "/" + item.url}`,
      })),
    };
  }

  // Auto-generate breadcrumbs from URL path
  const currentPath = url || Astro.url.pathname;
  if (!currentPath || currentPath === "/") {
    return null; // No breadcrumbs for homepage
  }

  const pathSegments = currentPath.split("/").filter(Boolean);
  const breadcrumbItems = [
    {
      "@type": "ListItem",
      position: 1,
      name: "Beranda",
      item: siteInfo.siteUrl,
    },
  ];

  // Map common path segments to readable names
  const segmentNameMap: Record<string, string> = {
    posts: "Artikel",
    news: "Berita",
    pengumuman: "Pengumuman",
    prestasi: "Prestasi",
    about: "Tentang Kami",
    contact: "Kontak",
    gallery: "Galeri",
    ppdb: "PPDB",
    page: "Halaman",
  };

  let accumulatedPath = "";
  pathSegments.forEach((segment, index) => {
    // Skip numeric segments (like page numbers) or slugs for the path building
    if (/^\d+$/.test(segment)) {
      return;
    }

    accumulatedPath += "/" + segment;

    // Get readable name
    let readableName =
      segmentNameMap[segment.toLowerCase()] ||
      segment.charAt(0).toUpperCase() + segment.slice(1).replace(/-/g, " ");

    // For the last segment, use the page title if available
    if (index === pathSegments.length - 1 && title) {
      readableName = title;
    }

    breadcrumbItems.push({
      "@type": "ListItem",
      position: breadcrumbItems.length + 1,
      name: readableName,
      item: `${siteInfo.siteUrl}${accumulatedPath}`,
    });
  });

  if (breadcrumbItems.length <= 1) {
    return null;
  }

  return {
    "@context": "https://schema.org",
    "@type": "BreadcrumbList",
    itemListElement: breadcrumbItems,
  };
};

const breadcrumbSchema = generateBreadcrumbSchema();
---

<!-- Favicon & Icons -->
<link rel="icon" href={siteInfo.favicon} type="image/x-icon" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />

<!-- Preconnect & DNS Prefetch for Performance -->
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link rel="dns-prefetch" href="https://www.googletagmanager.com" />
<link rel="dns-prefetch" href="https://www.google-analytics.com" />

<!-- External Stylesheets -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/@splidejs/splide@4.1.4/dist/css/splide.min.css"
/>

<!-- Basic Meta Tags -->
<title>{pageTitle}</title>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content={pageDescription} />
<meta name="theme-color" content="#1a1a2e" />
<meta name="format-detection" content="telephone=no" />
{
  globalMeta.defaultKeywords && (
    <meta name="keywords" content={globalMeta.defaultKeywords} />
  )
}
{globalMeta.author && <meta name="author" content={globalMeta.author} />}
{noindex && <meta name="robots" content={robotsContent} />}

<!-- Apple Mobile Web App -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content={siteInfo.siteName} />

<!-- Canonical URL -->
<link rel="canonical" href={canonicalUrl} />

<!-- Sitemap & RSS -->
<link rel="sitemap" type="application/xml" href="/sitemap-index.xml" />

<!-- Language Alternate -->
<link rel="alternate" hreflang="id" href={siteInfo.siteUrl} />
<link rel="alternate" hreflang="x-default" href={siteInfo.siteUrl} />

<!-- Open Graph Meta Tags -->
<meta property="og:title" content={pageTitle} />
<meta property="og:description" content={pageDescription} />
<meta property="og:type" content={pageType} />
<meta property="og:url" content={fullUrl} />
<meta property="og:site_name" content={siteInfo.siteName} />
{openGraph.locale && <meta property="og:locale" content={openGraph.locale} />}

{
  pageImage && (
    <>
      <meta property="og:image" content={getFullImageUrl(pageImage)} />
      <meta property="og:image:width" content="1200" />
      <meta property="og:image:height" content="630" />
      <meta property="og:image:alt" content={pageTitle} />
    </>
  )
}

{openGraph.fbAppId && <meta property="fb:app_id" content={openGraph.fbAppId} />}

{
  publishedTime && (
    <meta property="article:published_time" content={publishedTime} />
  )
}

{
  modifiedTime && (
    <meta property="article:modified_time" content={modifiedTime} />
  )
}

{
  tags.length > 0 &&
    tags.map((tag: string) => <meta property="article:tag" content={tag} />)
}

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content={twitter.card} />
<meta name="twitter:title" content={pageTitle} />
<meta name="twitter:description" content={pageDescription} />

{twitter.site && <meta name="twitter:site" content={twitter.site} />}

{twitter.creator && <meta name="twitter:creator" content={twitter.creator} />}

{
  pageImage && (
    <>
      <meta name="twitter:image" content={getFullImageUrl(pageImage)} />
      <meta name="twitter:image:alt" content={pageTitle} />
    </>
  )
}

<!-- Site Verification -->
{
  analyticsConfig.googleSiteVerification && (
    <meta
      name="google-site-verification"
      content={analyticsConfig.googleSiteVerification}
    />
  )
}

{
  analyticsConfig.bingSiteVerification && (
    <meta name="msvalidate.01" content={analyticsConfig.bingSiteVerification} />
  )
}

{
  analyticsConfig.yandexVerification && (
    <meta
      name="yandex-verification"
      content={analyticsConfig.yandexVerification}
    />
  )
}

<!-- Google Analytics -->
{
  analyticsConfig.gaId && (
    <>
      <script
        async
        src={`https://www.googletagmanager.com/gtag/js?id=${analyticsConfig.gaId}`}
      />
      <script>
        {`
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', '${analyticsConfig.gaId}');
      `}
      </script>
    </>
  )
}

<!-- Structured Data -->
{
  orgStructuredData && (
    <script
      type="application/ld+json"
      set:html={JSON.stringify(orgStructuredData)}
    />
  )
}

{
  websiteStructuredData && (
    <script
      type="application/ld+json"
      set:html={JSON.stringify(websiteStructuredData)}
    />
  )
}

<!-- Enhanced E-E-A-T Organization Schema -->
<script
  type="application/ld+json"
  set:html={JSON.stringify(enhancedOrgSchema)}
/>

<!-- BreadcrumbList Schema for Navigation -->
{
  breadcrumbSchema && (
    <script
      type="application/ld+json"
      set:html={JSON.stringify(breadcrumbSchema)}
    />
  )
}

<!-- Page-specific structured data -->
<script
  type="application/ld+json"
  set:html={JSON.stringify(
    pageType === "website"
      ? {
          "@context": "https://schema.org",
          "@type": "WebPage",
          name: pageTitle,
          description: pageDescription,
          url: fullUrl,
          publisher: {
            "@type": "EducationalOrganization",
            name: siteInfo.siteName,
            url: siteInfo.siteUrl,
          },
        }
      : {
          "@context": "https://schema.org",
          "@type": "Article",
          headline: pageTitle,
          description: pageDescription,
          url: fullUrl,
          image: pageImage ? getFullImageUrl(pageImage) : undefined,
          datePublished: publishedTime || undefined,
          dateModified: modifiedTime || publishedTime || undefined,
          author: {
            "@type": "Organization",
            name: globalMeta.author || siteInfo.siteName,
          },
          publisher: {
            "@type": "EducationalOrganization",
            name: siteInfo.siteName,
            url: siteInfo.siteUrl,
            logo: siteInfo.siteLogo
              ? {
                  "@type": "ImageObject",
                  url: getFullImageUrl(siteInfo.siteLogo),
                }
              : undefined,
          },
          keywords: tags.length > 0 ? tags.join(", ") : undefined,
        },
  )}
/>
