---
// src/components/Navbar.astro
import { getCollection } from "astro:content";

const settingsCollection = await getCollection("settings");
const settingsData = settingsCollection[0]?.data;

const headerData = settingsData?.header || {};
// Data untuk logo & nama
const schoolInfo = headerData?.schoolInfo || {
  name: "MAS MIFHDA",
  logo: "/uploads/logo-smp.png",
  logoAlt: "Logo Sekolah",
  logoWidthDesktop: 44,
  logoWidthMobile: 36,
  showName: true,
};

// Data untuk menu items
const menuItems = headerData?.items || [];

// Data untuk style settings
const styleSettings = headerData?.style || {
  bgColor: "#ffffff",
  textColor: "#1f2937",
  hoverColor: "#059669",
  borderColor: "#e5e7eb",
  bgTransparent: "solid",
};

// 3. FALLBACK JIKA DATA KOSONG
if (menuItems.length === 0) {
  menuItems.push(
    { label: "Profil", href: "/profile", isActive: true },
    { label: "Berita", href: "/posts/news", isActive: true },
    { label: "Pengumuman", href: "/posts/pengumuman", isActive: true },
    { label: "Prestasi", href: "/posts/prestasi", isActive: true },
    { label: "Kontak", href: "/contact", isActive: true },
  );
}

// Ambil data PPDB untuk label CTA
const ppdbCollection = await getCollection("ppdb");
const ppdbData = ppdbCollection[0]?.data?.datappdb;
const ppdbLabel = ppdbData?.ppdbAlias || "PPDB";

// Get current path for active state
const currentPath = Astro.url.pathname;

// Function to check if menu item is active
const isActiveLink = (href: string): boolean => {
  if (href === "/") {
    return currentPath === "/";
  }
  return currentPath.startsWith(href);
};
---

<nav
  role="navigation"
  x-data="{ scrolled: false }"
  x-init="window.addEventListener('scroll', () => { scrolled = window.scrollY > 10 })"
  class="navbar-main fixed shadow top-0 left-0 right-0 z-50"
  :class="scrolled ? 'navbar-scrolled' : 'navbar-top'"
>
  <div class="nav-container mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16 lg:h-[72px]">
      <!-- Logo & Brand -->
      <a
        href="/"
        class="group flex gap-2.5 items-center nav-logo relative z-10"
      >
        <!-- Logo Container -->
        <div class="relative logo-container">
          <!-- Subtle glow on hover -->
          <div class="logo-glow"></div>
          <img
            src={schoolInfo.logo}
            alt={schoolInfo.logoAlt}
            class="h-auto relative z-10 transition-transform duration-300 group-hover:scale-105"
            style={`width: ${schoolInfo.logoWidthDesktop}px;`}
            width={schoolInfo.logoWidthDesktop}
            height={schoolInfo.logoWidthDesktop}
          />
        </div>

        <!-- Nama Sekolah -->
        {
          schoolInfo.showName && (
            <div class="hidden sm:flex flex-col leading-tight">
              <span class="text-base font-bold text-heading uppercase tracking-wide">
                {schoolInfo.name}
              </span>
            </div>
          )
        }
      </a>

      <!-- Menu Desktop -->
      <ul class="hidden lg:flex items-center gap-0.5">
        {
          menuItems.map((item, index) => {
            const isActive = isActiveLink(item.href);
            return (
              <li class="nav-item" style={`--item-index: ${index}`}>
                <a
                  href={item.href}
                  class={`nav-link relative px-4 py-2 rounded-lg font-medium text-[13px] transition-all duration-200 ${
                    isActive
                      ? "nav-link-active text-primary"
                      : "text-text/70 hover:text-heading hover:bg-primary/5"
                  }`}
                  data-active={isActive}
                >
                  <span class="relative z-10">{item.label}</span>
                  {/* Active indicator */}
                  {isActive && (
                    <span class="absolute bottom-0 left-1/2 -translate-x-1/2 w-5 h-0.5 bg-gradient-to-r from-primary to-secondary rounded-full" />
                  )}
                </a>
              </li>
            );
          })
        }
      </ul>

      <!-- Right Side Actions -->
      <div class="flex items-center gap-3">
        <!-- CTA Button Desktop -->
        <a
          href="/ppdb"
          class="hidden lg:inline-flex cta-btn items-center gap-2 px-5 py-2.5 rounded-xl font-semibold text-[13px] transition-all duration-300 hover:shadow-lg hover:shadow-primary/25 active:scale-[0.98]"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-4 h-4 text-white"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"
            ></path>
          </svg>
          <p class="text-white">{ppdbLabel}</p>
        </a>

        <!-- Hamburger Button -->
        <button
          class="lg:hidden relative w-11 h-11 flex items-center justify-center rounded-xl bg-primary/5 hover:bg-primary/10 border border-primary/10 transition-all duration-200 z-10"
          x-on:click="window.mobileMenu && window.mobileMenu.toggle()"
          aria-label="Toggle navigation"
        >
          <div class="w-5 h-3.5 relative flex flex-col justify-between">
            <span
              class="w-full h-0.5 bg-primary rounded-full transition-all duration-300 origin-center"
            ></span>
            <span
              class="w-2/3 h-0.5 bg-primary rounded-full transition-all duration-300 ml-auto"
            ></span>
            <span
              class="w-full h-0.5 bg-primary rounded-full transition-all duration-300 origin-center"
            ></span>
          </div>
        </button>
      </div>
    </div>
  </div>
</nav>

<!-- Mobile Menu (di luar nav untuk menghindari inheritance) -->
<div
  x-data="{ open: false }"
  x-init="window.mobileMenu = { toggle: () => open = !open, close: () => open = false }"
  x-effect="document.body.style.overflow = open ? 'hidden' : ''"
>
  <!-- Mobile Menu Overlay -->
  <div
    class="fixed inset-0 bg-black/70 lg:hidden z-[9998]"
    x-show="open"
    x-transition:enter="transition ease-out duration-200"
    x-transition:enter-start="opacity-0"
    x-transition:enter-end="opacity-100"
    x-transition:leave="transition ease-in duration-150"
    x-transition:leave-start="opacity-100"
    x-transition:leave-end="opacity-0"
    x-on:click="open = false"
    x-cloak
  >
  </div>

  <!-- Mobile Menu Panel -->
  <div
    class="fixed inset-y-0 right-0 w-[300px] max-w-[85vw] lg:hidden z-[9999]"
    style="background-color: #f6f6f6;"
    x-show="open"
    x-transition:enter="transition ease-out duration-300"
    x-transition:enter-start="translate-x-full"
    x-transition:enter-end="translate-x-0"
    x-transition:leave="transition ease-in duration-200"
    x-transition:leave-start="translate-x-0"
    x-transition:leave-end="translate-x-full"
    x-cloak
  >
    <div class="h-full flex flex-col" style="background-color: #f6f6f6;">
      <!-- Mobile Header -->
      <div
        class="flex items-center justify-between p-4 border-b border-border/30"
      >
        <div class="flex items-center gap-2.5">
          <img
            src={schoolInfo.logo}
            alt={schoolInfo.logoAlt}
            class="h-auto"
            style={`width: ${schoolInfo.logoWidthMobile}px;`}
            width={schoolInfo.logoWidthMobile}
            height={schoolInfo.logoWidthMobile}
          />
          <div class="flex flex-col leading-tight">
            <span class="text-sm font-bold text-heading uppercase"
              >{schoolInfo.name}</span
            >
          </div>
        </div>
        <button
          class="w-9 h-9 flex items-center justify-center rounded-lg bg-muted/10 hover:bg-muted/20 transition-colors"
          x-on:click="open = false"
          aria-label="Close menu"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-5 h-5 text-muted"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M6 18 18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      <!-- Mobile Menu Items -->
      <nav class="flex-1 p-4">
        <ul class="space-y-1">
          {
            menuItems.map((item, index) => {
              const isActive = isActiveLink(item.href);
              return (
                <li style={`--delay: ${index * 40}ms`} class="mobile-item">
                  <a
                    href={item.href}
                    class={`flex items-center gap-3 px-4 py-3 rounded-xl font-medium text-[15px] transition-all duration-200 ${
                      isActive
                        ? "bg-primary"
                        : "text-text/80 hover:bg-muted/10 hover:text-heading"
                    }`}
                    x-on:click="open = false"
                  >
                    <span
                      class={`w-1.5 h-1.5 rounded-full ${isActive ? "bg-white" : "bg-primary/40"}`}
                    />
                    <span class={`flex-1  ${isActive ? "text-white" : ""}`}>
                      {item.label}
                    </span>
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      fill="none"
                      viewBox="0 0 24 24"
                      stroke-width="2"
                      stroke="currentColor"
                      class={`w-4 h-4 transition-transform ${isActive ? "text-white/70" : "text-muted/50"}`}
                    >
                      <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        d="m8.25 4.5 7.5 7.5-7.5 7.5"
                      />
                    </svg>
                  </a>
                </li>
              );
            })
          }
        </ul>
      </nav>

      <!-- Mobile CTA -->
      <div class="p-4 border-t border-border/30">
        <a
          href="/ppdb"
          class="flex items-center justify-center gap-2 w-full px-5 py-3.5 rounded-xl font-semibold bg-gradient-to-r from-primary to-secondary transition-all duration-200 active:scale-[0.98]"
          x-on:click="open = false"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="2"
            stroke="currentColor"
            class="w-5 h-5 text-white"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              d="M4.26 10.147a60.438 60.438 0 0 0-.491 6.347A48.62 48.62 0 0 1 12 20.904a48.62 48.62 0 0 1 8.232-4.41 60.46 60.46 0 0 0-.491-6.347m-15.482 0a50.636 50.636 0 0 0-2.658-.813A59.906 59.906 0 0 1 12 3.493a59.903 59.903 0 0 1 10.399 5.84c-.896.248-1.783.52-2.658.814m-15.482 0A50.717 50.717 0 0 1 12 13.489a50.702 50.702 0 0 1 7.74-3.342M6.75 15a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5Zm0 0v-3.675A55.378 55.378 0 0 1 12 8.443m-7.007 11.55A5.981 5.981 0 0 0 6.75 15.75v-1.5"
            ></path>
          </svg>
          <p class="text-white">Daftar PPDB</p>
        </a>
        <p class="text-[11px] text-muted/60 text-center mt-3">
          Â© {new Date().getFullYear()}
          {schoolInfo.name}
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Spacer -->
<div class="h-16 lg:h-[72px]"></div>

<style>
  /* Nav Container */
  .nav-container {
    max-width: 1280px;
  }

  /* Navbar Base */
  .navbar-main {
    transition: all 0.3s ease;
  }

  .navbar-top {
    background: transparent;
  }

  .navbar-scrolled {
    background: rgba(var(--color-surface-rgb, 255, 255, 255), 0.85);
    backdrop-filter: blur(12px) saturate(150%);
    -webkit-backdrop-filter: blur(12px) saturate(150%);
    box-shadow:
      0 1px 0 rgba(0, 0, 0, 0.05),
      0 4px 20px rgba(0, 0, 0, 0.03);
  }

  /* Logo Glow */
  .logo-container {
    position: relative;
  }

  .logo-glow {
    position: absolute;
    inset: -4px;
    background: linear-gradient(
      135deg,
      var(--color-primary),
      var(--color-secondary)
    );
    border-radius: 50%;
    opacity: 0;
    filter: blur(8px);
    transition: opacity 0.3s ease;
  }

  .nav-logo:hover .logo-glow {
    opacity: 0.2;
  }

  /* Nav Links */
  .nav-link {
    position: relative;
  }

  .nav-link-active {
    font-weight: 600;
  }

  /* Nav Item Animation */
  .nav-item {
    opacity: 0;
    animation: fadeIn 0.4s ease forwards;
    animation-delay: calc(var(--item-index) * 40ms);
  }

  @keyframes fadeIn {
    to {
      opacity: 1;
    }
  }

  /* CTA Button */
  .cta-btn {
    background: linear-gradient(
      135deg,
      var(--color-primary),
      var(--color-secondary)
    );
  }

  /* Mobile Panel */
  .mobile-panel {
    background-color: #ffffff;
    background-color: var(--color-surface, #ffffff);
    box-shadow: -8px 0 30px rgba(0, 0, 0, 0.2);
    isolation: isolate;
  }

  :root.dark .mobile-panel {
    background-color: #1a1a1a;
    background-color: var(--color-surface, #1a1a1a);
  }

  /* Mobile Item Animation */
  .mobile-item {
    opacity: 0;
    animation: slideIn 0.3s ease forwards;
    animation-delay: var(--delay, 0ms);
  }

  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(16px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }

  /* Alpine.js cloak */
  [x-cloak] {
    display: none !important;
  }

  /* Dark Mode */
  :root.dark .navbar-scrolled {
    background: rgba(var(--color-surface-rgb, 24, 24, 27), 0.9);
    box-shadow:
      0 1px 0 rgba(255, 255, 255, 0.05),
      0 4px 20px rgba(0, 0, 0, 0.2);
  }

  /* Scrollbar */
  .mobile-panel nav::-webkit-scrollbar {
    width: 3px;
  }

  .mobile-panel nav::-webkit-scrollbar-thumb {
    background: var(--color-border);
    border-radius: 3px;
  }
</style>

<script>
  // Close mobile menu on escape key
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      const nav = document.querySelector("[x-data]") as HTMLElement & {
        __x?: { $data?: { open: boolean } };
      };
      if (nav && nav.__x && nav.__x.$data) {
        nav.__x.$data.open = false;
      }
    }
  });
</script>
